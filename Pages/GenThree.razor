@page "/genthree"
@using Newtonsoft.Json
@using ServerSideProject.Data

<PageTitle>Gen Three</PageTitle>
<div class="pageTitle">
    <p style="padding-top: 20px;">Gen Three</p>
    <Button @onclick="OnShowOffcanvasClick">Search Pokedex!</Button>
</div>

@if (allGen3 == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <Modal @ref="modal" UseStaticBackdrop="true" CloseOnEscape="false" />
    <Modal @ref="modalGrid" UseStaticBackdrop="true" CloseOnEscape="false" />

    // Offcanvas with grid display for search feature
    <Offcanvas @ref="offcanvas" Title="Search Our Pokedex!" Size="OffcanvasSize.Large" >
        <BodyTemplate> 
            <Grid TItem="Pokemon" Class="table table-hover table-bordered table-striped testing4" DataProvider="PokemonDataProvider" AllowFiltering="true" Responsive="true" AllowRowClick="true" OnRowDoubleClick="ShowPokemonGridModal">
                <GridColumn TItem="Pokemon" HeaderText="Pokedex Id" PropertyName="Id">
                    @context.Id 
                </GridColumn>
                <GridColumn TItem="Pokemon" HeaderText="Name" PropertyName="Name" StringComparison="StringComparison.Ordinal">
                    @context.Name
                </GridColumn>
                <GridColumn TItem="Pokemon" HeaderText="Type"  PropertyName="context.Types[0].Type.Name" >
                    @context.Types[0].Type.Name
                </GridColumn>
            </Grid>
        </BodyTemplate>
    </Offcanvas>
    

    <table class="pokemon-table-spacing container-fluid">
        @for (int i = 0; i < allGen3.Count(); i += 3)
        {
            var j = allGen3[i];
            <tr>
                <td class="pokemon-List pokemon-@allGen3[i].Types[0].Type.Name.ToString() col-md-4" @onclick="() => ShowPokemonModal(j)">
                    <h3 class="pokemon-name">@allGen3[i].Name.ToUpper()</h3>

                    @if (@allGen3[i].Types.Count() > 1)
                    {
                        <h3 class="pokemon-type">@allGen3[i].Types[0].Type.Name.ToString().ToUpper()/@allGen3[i].Types[1].Type.Name.ToString().ToUpper()</h3>
                    }
                    else
                    {
                        <h3 class="pokemon-type">@allGen3[i].Types[0].Type.Name.ToString().ToUpper()</h3>
                    }

                    <br>
                    <div class="pokemon-sprite-container">
                        <img class="pokemon-sprite" src="@allGen3[i].SpriteURL" alt="@allGen3[i].Name">
                    </div>
                    <BarChartComponent Title="@($"{allGen3[i].Name.ToUpper()} STATS")" Values="PData" selectedPokemon="@allGen3[i].Id" />

                </td>
                @if (i + 1 <= allGen3.Count() - 1)
                {
                    var m = allGen3[i + 1];
                    <td class="pokemon-List pokemon-@allGen3[i+1].Types[0].Type.Name.ToString() col-md-4" @onclick="() => ShowPokemonModal(m)">
                        <h3 class="pokemon-name ">@allGen3[i + 1].Name.ToUpper()</h3>

                        @if (@allGen3[i + 1].Types.Count() > 1)
                        {
                            <h3 class="pokemon-type">@allGen3[i + 1].Types[0].Type.Name.ToString().ToUpper()/@allGen3[i + 1].Types[1].Type.Name.ToString().ToUpper()</h3>
                        }
                        else
                        {
                            <h3 class="pokemon-type">@allGen3[i + 1].Types[0].Type.Name.ToString().ToUpper()</h3>
                        }

                        <br>
                        <div class="pokemon-sprite-container">
                            <img class="pokemon-sprite" src="@allGen3[i + 1].SpriteURL" alt="@allGen3[i + 1].Name">
                        </div>


                        <BarChartComponent Title="@($"{allGen3[i+1].Name.ToUpper()} STATS")" Values="PData" selectedPokemon="@allGen3[i+1].Id" />
                    </td>
                    @if (i + 2 <= allGen3.Count() - 1)
                    {
                        var n = allGen3[i + 2];
                        <td class="pokemon-List pokemon-@allGen3[i+2].Types[0].Type.Name.ToString() col-md-4" @onclick="() => ShowPokemonModal(n)">
                            <h3 class="pokemon-name ">@allGen3[i + 2].Name.ToUpper()</h3>
                            @if (@allGen3[i + 2].Types.Count() > 1)
                            {
                                <h3 class="pokemon-type">@allGen3[i + 2].Types[0].Type.Name.ToString().ToUpper()/@allGen3[i + 2].Types[1].Type.Name.ToString().ToUpper()</h3>
                            }
                            else
                            {
                                <h3 class="pokemon-type">@allGen3[i + 2].Types[0].Type.Name.ToString().ToUpper()</h3>
                            }

                            <br>
                            <div class="pokemon-sprite-container">
                                <img class="pokemon-sprite" src="@allGen3[i + 2].SpriteURL" alt="@allGen3[i + 2].Name">
                            </div>
                            <BarChartComponent Title="@($"{allGen3[i+2].Name.ToUpper()} STATS")" Values="PData" selectedPokemon="@allGen3[i+2].Id" />
                        </td>
                    }
                }
            </tr>
        }
    </table>
}

@code {
    public Pokemon[]? allGen3;
    private IEnumerable<Pokemon> gridListGen3;
    private List<(string, int)>? specificPokemonStat;
    private Dictionary<int, IEnumerable<(string, int)>> PData;
    private Dictionary<int, IEnumerable<(string, int)>> PData2;

    // For Modal display
    public Pokemon CurrentPokemon = new Pokemon();
    private Modal modal = default!;
    private string? message;

    // For Grid Modal
    public Pokemon GridCurrentPokemon = new Pokemon();
    private Modal modalGrid = default!;
   

    // Off Canvas Code
    private Offcanvas offcanvas;
    private async Task OnShowOffcanvasClick()
    {
        await offcanvas?.ShowAsync();
    }


    // Read in JSON file
    string json = System.IO.File.ReadAllText("./Data/gen3.json");
    protected override async Task OnInitializedAsync()
    {
        // Pokemon array for regular display
        allGen3 = Newtonsoft.Json.JsonConvert.DeserializeObject<Pokemon[]>(json);
        Dictionary<int, IEnumerable<(string, int)>> Data = new Dictionary<int, IEnumerable<(string, int)>>();
        foreach (Pokemon pokemon in allGen3)
        {
            List<(string, int)> valuesList = new List<(string, int)>();
            foreach (var stat in pokemon.Stats)
            {
                string statName = stat.Stat.Name.ToString().ToUpper();
                int statNum = stat.BaseStat;
                var statItem = (statName, statNum);
                valuesList.Add(statItem);
            }
            IEnumerable<(string, int)> Values = valuesList;
            Data.Add(pokemon.Id, Values);
        }
        PData = Data;


        // Pokemon list for Offcanvas and Grid display
        gridListGen3 = Newtonsoft.Json.JsonConvert.DeserializeObject<Pokemon[]>(json);
        Dictionary<int, IEnumerable<(string, int)>> Data2 = new Dictionary<int, IEnumerable<(string, int)>>();
        foreach (Pokemon pokemon in gridListGen3)
        {
            List<(string, int)> valuesList = new List<(string, int)>();
            foreach (var stat in pokemon.Stats)
            {
                string statName = stat.Stat.Name.ToString().ToUpper();
                int statNum = stat.BaseStat;
                var statItem = (statName, statNum);
                valuesList.Add(statItem);
            }
            IEnumerable<(string, int)> Values = valuesList;
            Data2.Add(pokemon.Id, Values);
        }
        PData2 = Data2; // PData2 has no values, only keys
    }


    // Data provider method for grid
    private async Task<GridDataProviderResult<Pokemon>> PokemonDataProvider(GridDataProviderRequest<Pokemon> request)
    {
        return await Task.FromResult(request.ApplyTo(gridListGen3));
    }


    // Modal display method for grid
    private async Task ShowPokemonGridModal(GridRowEventArgs<Pokemon> args)
    {
        GridCurrentPokemon.SpriteURL = args.Item.SpriteURL;
        GridCurrentPokemon.Abilities = args.Item.Abilities;
        GridCurrentPokemon.Stats = args.Item.Stats;
        GridCurrentPokemon.Weight = args.Item.Weight;
        GridCurrentPokemon.Height = args.Item.Height;
        GridCurrentPokemon.Id = args.Item.Id;
        GridCurrentPokemon.Moves = args.Item.Moves;
        GridCurrentPokemon.Types = args.Item.Types;
        GridCurrentPokemon.Name = args.Item.Name;
        var parameters = new Dictionary<string, object>();
        parameters.Add("Pokemon", GridCurrentPokemon);
        await modalGrid.ShowAsync<GridModal>(title: "Grid Pokemon Modal", parameters: parameters);
    }

    // Regular Modal dispaly from Pokemon card
    private async Task ShowPokemonModal(Pokemon newP)
    {
        SetC(newP);
        var parameters = new Dictionary<string, object>();
        parameters.Add("Pokemon", CurrentPokemon);
        await modal.ShowAsync<PokemonModal>(title: "Regular Pokemon Modal", parameters: parameters);
    }

    // Sets current Pokemon for regular modal display
    private void SetC(Pokemon newP)
    {
        CurrentPokemon = newP;
    }
}


